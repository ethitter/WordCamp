<html>
	<head>
		<title>WordCamp Phoenix 2013 - From URL to Query</title>

		<!-- syntax highlighter styles -->
		<link rel="stylesheet" href="../impress-js-master/syntax-highlighter/styles/shCore.css" />
		<!-- Pick a theme from /master/syntax-highlighter/styles/ -->
		<link rel="stylesheet" href="../impress-js-master/syntax-highlighter/styles/shThemeEclipse.css" />

		<link rel="stylesheet" href="../impress-js-master/style.css" />

		<!-- syntax highlighter depends on XRegExp.js -->
		<script type="text/javascript" src="../impress-js-master/XRegExp.js"></script>
		<script type="text/javascript" src="../impress-js-master/syntax-highlighter/src/shCore.js"></script>
		<script type="text/javascript" src="../impress-js-master/syntax-highlighter/scripts/shBrushBash.js"></script>
		<script type="text/javascript" src="../impress-js-master/syntax-highlighter/scripts/shBrushPhp.js"></script>
	</head>
	<body class="impress-not-supported">

	<!--
			For example this fallback message is only visible when there is `impress-not-supported` class on body.
	-->
	<div class="fallback-message">
			<p>Your browser <b>doesn't support the features required</b> by impress.js, so you are presented with a simplified version of this presentation.</p>
			<p>For the best experience please use the latest <b>Chrome</b>, <b>Safari</b> or <b>Firefox</b> browser.</p>
	</div>

	<div class="hint">
			<p>Use a spacebar or arrow keys to navigate</p>
	</div>
	<script>
	if ("ontouchstart" in document.documentElement) {
			document.querySelector(".hint").innerHTML = "<p>Tap on the left or right to navigate</p>";
	}
	</script>

	<div id="impress">
		<div id="intro" class="step slide" data-x="0" data-y="0">
			<h1>From URL to Query</h1>
			<h2>WordCamp Phoenix 2013</h2>

			<div class="intro-credits">
				<p>Erick Hitter</p>
				<p>Design Engineer @ Automattic</p>
				<p><a href="http://www.twitter.com/ethitter" target="_blank">@ethitter</a></p>
			</div>
		</div>

		<div class="step slide" data-x="1500" data-y="0">
			<h1>About Me</h1>

			<ul>
				<li>Design Engineer at Automattic, the company behind WordPress.com</li>
				<li>Formerly a Senior WordPress Developer with Oomph, Inc. working on the WordPress.com VIP platform</li>
				<li>3+ years developing WordPress themes and plugins</li>
				<li>WordPress Core Contributor</li>
				<li>WordCamp Boston Organizer</li>
				<li>Boston WordPress Meetup organizer</li>
				<li>Plugin Author</li>
			</ul>
		</div>

		<div class="step slide" data-x="1500" data-y="900">
			<h1>Assumptions we'll operate under</h1>

			<ul>
				<li>Using <a href="http://codex.wordpress.org/Using_Permalinks#mod_rewrite:_.22Pretty_Permalinks.22" target="_blank">Pretty Permalinks</a>.</li>
				<li>Not making requests to <code>/wp-admin/</code>.</li>
			</ul>
		</div>

		<div class="step slide" data-x="1500" data-y="1800">
			<h1>The Premise</h1>

			<p>&nbsp;</p>

			<ul>
				<li>Ever wonder what process WordPress undertakes when someone visits your site?</li>
				<li>Or how it translates that nice permalink to the database query that ultimately delivers the content your visitors requested?</li>
				<li>Or what it takes to load the appropriate template from your site's theme?</li>
			</ul>
		</div>

		<div class="step slide" data-x="3000" data-y="1800">
			<h1>In Short...</h1>

			<h1 class="middle" style="color: #4D4D4D;">Magic</h1>
		</div>

		<div class="step slide" data-x="4500" data-y="1800">
			<h1>Seriously though</h1>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<h2>WordPress contains a number of classes that work together with the help of some procedural glue.</h2>
		</div>

		<div class="step slide" data-x="4500" data-y="2700">
			<h1>Getting started: <code>index.php</code></h1>

			<p>With Pretty Permalinks, requests that don't correspond to actual files on the server are sent to <code>index.php</code>.</p>

			<p>Not much going on here:</p>

			<p>&nbsp;</p>

			<div class="code-container">
				<pre class="brush: php; gutter: true;">&lt;?php
/**
 * Front to the WordPress application. This file doesn't do anything, but loads
 * wp-blog-header.php which does and tells WordPress to load the theme.
 *
 * @package WordPress
 */

/**
 * Tells WordPress to load the WordPress theme and output it.
 *
 * @var bool
 */
define('WP_USE_THEMES', true);

/** Loads the WordPress Environment and Template */
require('./wp-blog-header.php');
</pre>
			</div><!-- .code-container -->
		</div>

		<div class="step slide" data-x="6000" data-y="2700">
			<h1><code>wp-blog-header.php</code></h1>

			<p>Not much here either, but what's here is <em>important</em>!</p>

			<p>&nbsp;</p>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [12,14,16]">&lt;?php
/**
 * Loads the WordPress environment and template.
 *
 * @package WordPress
 */

if ( !isset($wp_did_header) ) {

	$wp_did_header = true;

	require_once( dirname(__FILE__) . '/wp-load.php' );

	wp();

	require_once( ABSPATH . WPINC . '/template-loader.php' );

}
</pre>
			</div><!-- .code-container -->
		</div>

		<div class="step slide" data-x="7500" data-y="2700">
			<h1>In conclusion</h1>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<h2 style="text-align: center;">You caught those three highlighted lines, right?</h2>

			<p>&nbsp;</p>

			<h2 style="text-align: center;">So we can go home now?</h2>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<p style="text-align: center;"><small>:)</small></p>
		</div>

		<div class="step slide" data-x="9000" data-y="2700">
			<h1>What do I mean?</h1>

			<h2>Remember the premises?</h2>

			<p>&nbsp;</p>

			<div class="code-container">
				<pre class="brush: php; gutter: true;">&lt;?php
// Ever wonder what process WordPress undertakes when someone visits your site?
require_once( dirname(__FILE__) . '/wp-load.php' );

// Or how it translates that nice permalink to the database query that ultimately
// delivers the content your visitors requested?
wp();

// Or what it takes to load the appropriate template from your site's theme?
require_once( ABSPATH . WPINC . '/template-loader.php' );
</pre>
			</div><!-- .code-container -->
		</div>

		<div class="step slide" data-x="10500" data-y="2700">
			<h1>Need more granular control?</h1>

			<p>&nbsp;</p>

			<h1 style="color: #4d4d4d;"><code>map_meta_cap</code> is your friend</h1>
		</div>

		<div class="step slide" data-x="12000" data-y="2700">
			<h1>But why?</h1>

			<p>With <code>map_meta_cap</code>, you can:</p>

			<ul>
				<li>Prevent a specific post from being modified (edited, status changed, deleted, etc).</li>
				<li>Block a specific user from performing some action his/her role would otherwise allow.</li>
				<li>Grant a user a capability in a particular situation.</li>
			</ul>

			<p>&nbsp;</p>

			<p>In short, this provides a level of control beyond just the roles themselves.</p>
		</div>

		<div class="step slide" data-x="13500" data-y="2700">
			<h1>But how?</h1>

			<p>There are really two types of capabilities in WordPress:</p>

			<ul>
				<li><strong>primitive</strong> - broad indication that a given role <em>might</em> or <em>might not</em> be able to do something</li>
				<li><strong>meta</strong> - contextual determination that a given user <em>can</em> or <em>cannot</em> do something</li>
			</ul>

			<p>&nbsp;</p>

			<p><code>map_meta_cap</code> translates a user's primitive capabilities to his/her meta capabilities.</p>
		</div>

		<div class="step slide" data-x="15000" data-y="2700">
			<h1>How are the two different?</h1>

			<ul>
				<li>Primitive capabilities are assigned to user roles.</li>
				<li>Meta capabilities <em>never should be</em> assigned to a role.</li>
				<li>
					Primitive capabilities are generally plural, meta capabilities are singular.
					<ul>
						<li><code>edit_posts</code></li>
						<li><code>edit_post</code></li>
					</ul>
				</li>
			</ul>
		</div>

		<div class="step slide" data-x="16500" data-y="2700">
			<h1>Contextual determination? Say what?</h1>

			<p><strong>Intent</strong>: to publish a post you wrote</p>

			<p><strong>Need</strong>: <code>publish_posts</code>, <code>edit_posts</code></p>
		</div>

		<div class="step slide" data-x="18000" data-y="2700">
			<h1>Contextual determination? Say what?</h1>

			<p><strong>Intent</strong>: to publish a post someone else wrote</p>

			<p><strong>Need</strong>: <code>publish_posts</code>, <code>edit_posts</code>, <code>edit_others_posts</code></p>
		</div>

		<div class="step slide" data-x="19500" data-y="2700">
			<h1>Contextual determination? Say what?</h1>

			<p><strong>Intent</strong>: to moderate a comment</p>

			<p><strong>Need</strong>: <code>moderate_comments</code>, <code>edit_posts</code></p>
		</div>

		<div class="step slide" data-x="21000" data-y="2700">
			<h1 class="middle">In other words, <code>map_meta_cap</code> introduces dependencies within WordPress' capabilities system.</h1>
		</div>

		<div class="step slide" data-x="22500" data-y="2700">
			<h1 class="middle">Questions before we move into code?</h1>
		</div>

		<div class="step slide" data-x="22500" data-y="3600">
			<h1><code>map_meta_cap</code></h1>

			<h2><code>map_meta_cap()</code> is in <code>wp-includes/capabilities.php</code>.</h2>

			<p>&nbsp;</p>

			<p>Within that function is the <code>map_meta_cap</code> filter.</p>

			<p>&nbsp;</p>

			<p>WordPress handles the function, we really care about the filter.</p>
		</div>

		<div class="step slide" data-x="24000" data-y="3600">
			<h1><code>map_meta_cap</code></h1>

			<code>apply_filters('map_meta_cap', $caps, $cap, $user_id, $args)</code>

			<ul>
				<li><code>'map_meta_cap'</code>: filter name</li>
				<li><code>$caps</code>: all of the meta capabilities already determined by WordPress</li>
				<li><code>$cap</code>: the primitive capability that triggered this filter call</li>
				<li><code>$user_id</code>: user ID either for the current user or a specific user when using <code>user_can()</code></li>
				<li><code>$args</code>: optional additional information relevant to current capability check</li>
			</ul>
		</div>

		<div class="step slide" data-x="25500" data-y="3600">
			<h1><code>$args</code></h1>

			<p><strong>This is important!</strong></p>

			<p>&nbsp;</p>

			<p>The <code>$args</code> parameter is both incredibly useful, and annoyingly vague.</p>

			<p>&nbsp;</p>

			<p><code>$args</code> is a numerically-indexed array whose values contain data relevant to the current capabilities check.</p>

			<p>&nbsp;</p>

			<p>Unfortunately, isn't always populated, forcing one to use globals in some cases.</p>

			<p>&nbsp;</p>

			<p>Clear as mud, right?</p>
		</div>

		<div class="step slide" data-x="27000" data-y="3600">
			<h1>Block deletion</h1>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [18];">&lt;?php
/**
 * Prevent a post from being deleted if a meta key is present
 *
 * @param array $caps
 * @param string $cap
 * @param int $user_id
 * @param array $args
 * @uses get_post_meta
 * @filter map_meta_cap
 * @return array
 */
function wcto_block_post_deletion( $caps, $cap, $user_id, $args ) {
	if (
		'delete_post' == $cap
		&& get_post_meta( (int) $args[0], '_block_deletion', true )
	)
		$caps[] = 'do_not_allow';

	return $caps;
}
add_filter( 'map_meta_cap', 'wcto_block_post_deletion', 10, 4 );
?&gt;</pre>
			</div>
		</div>

		<div class="step slide" data-x="28500" data-y="3600">
			<h1>Block file uploads</h1>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [18];">&lt;?php
/**
 * Prevent specific users from uploading files
 *
 * @param array $caps
 * @param string $cap
 * @param int $user_id
 * @param array $args
 * @uses get_user_meta
 * @filter map_meta_cap
 * @return array
 */
function wcto_limit_uploads( $caps, $cap, $user_id, $args ) {
	if (
		'upload_files' == $cap
		&& (bool) get_user_meta( $user_id, 'disallow_uploads', true )
	)
		$caps[] = 'do_not_allow';

	return $caps;
}
add_filter( 'map_meta_cap', 'wcto_limit_uploads', 10, 4 );
?&gt;</pre>
			</div>
		</div>

		<div class="step slide" data-x="30000" data-y="3600">
			<h1>Magic of <code>do_not_allow</code></h1>

			<p>When preventing something, you don't need to remove the capabilities that let a user perform an action.</p>

			<p><code style="text-decoration: line-through;">unset( $caps['edit_posts'] );</code></p>

			<p>&nbsp;</p>

			<p>Instead, add <code>do_not_allow</code> to the <code>$caps</code> array and WP ignores the other meta capabilities it determined.</p>
		</div>

		<div class="step slide" data-x="31500" data-y="3600">
			<h1>Allow editing</h1>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [20];">&lt;?php
/**
 * Allow a contributor to edit a particular published post
 *
 * @param array $caps
 * @param string $cap
 * @param int $user_id
 * @param array $args
 * @uses get_post_meta
 * @filter map_meta_cap
 * @return array
 */
function wcto_allow_contrib_edit_post( $caps, $cap, $user_id, $args ) {
	if (
		'edit_post' == $cap
		&& isset( $args[0] )
		&& (bool) get_post_meta( (int) $args[0], '_allow_contribs_to_edit', true )
		&& get_post_field( 'post_author', (int) $args[0] ) == $user_id
	)
		$caps = array( 'edit_posts' );

	return $caps;
}
add_filter( 'map_meta_cap', 'wcto_allow_contrib_edit_post', 10, 4 );
?&gt;</pre>
			</div>
		</div>

		<div class="step slide" data-x="33000" data-y="3600">
			<h1>Note about overriding</h1>

			<p>When overriding to grant a capability, you often must clear the <code>$caps</code> array of the capabilities you're overridding.</p>

			<p>In other words, there is no <code>allow</code> cap that has the opposite effect as <code>do_not_allow</code>.</p>
		</div>

		<div class="step slide" data-x="33000" data-y="4500">
			<h1>Questions?</h1>

			<h2>Slides are available at <a href="http://www.ethitter.com/blog/" target="_blank">http://www.ethitter.com/blog/</a>.</h2>

			<h2>Check Twitter for a link as well: <a href="http://www.twitter.com/ethitter" target="_blank">@ethitter</a>.</h2>
		<!-- end -->
	</div>
	<!--

			Last, but not least.

			To make all described above really work, you need to include impress.js in the page.
			I strongly encourage to minify it first.

			In here I just include full source of the script to make it more readable.

			You also need to call a `impress().init()` function to initialize impress.js presentation.
			And you should do it in the end of your document. Not only because it's a good practice, but also
			because it should be done when the whole document is ready.
			Of course you can wrap it in any kind of "DOM ready" event, but I was too lazy to do so ;)

	-->
	<script src="../impress-js-master/impress.js"></script>
	<script>SyntaxHighlighter.all(); impress().init();</script>

	</body>
</html>

