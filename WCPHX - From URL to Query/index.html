<html>
	<head>
		<title>WordCamp Phoenix 2013 - From URL to Query</title>

		<!-- syntax highlighter styles -->
		<link rel="stylesheet" href="../impress-js-master/syntax-highlighter/styles/shCore.css" />
		<!-- Pick a theme from /master/syntax-highlighter/styles/ -->
		<link rel="stylesheet" href="../impress-js-master/syntax-highlighter/styles/shThemeEclipse.css" />

		<link rel="stylesheet" href="../impress-js-master/style.css" />

		<!-- syntax highlighter depends on XRegExp.js -->
		<script type="text/javascript" src="../impress-js-master/XRegExp.js"></script>
		<script type="text/javascript" src="../impress-js-master/syntax-highlighter/src/shCore.js"></script>
		<script type="text/javascript" src="../impress-js-master/syntax-highlighter/scripts/shBrushBash.js"></script>
		<script type="text/javascript" src="../impress-js-master/syntax-highlighter/scripts/shBrushPhp.js"></script>
	</head>
	<body class="impress-not-supported">

	<!--
			For example this fallback message is only visible when there is `impress-not-supported` class on body.
	-->
	<div class="fallback-message">
			<p>Your browser <b>doesn't support the features required</b> by impress.js, so you are presented with a simplified version of this presentation.</p>
			<p>For the best experience please use the latest <b>Chrome</b>, <b>Safari</b> or <b>Firefox</b> browser.</p>
	</div>

	<div class="hint">
			<p>Use a spacebar or arrow keys to navigate</p>
	</div>
	<script>
	if ("ontouchstart" in document.documentElement) {
			document.querySelector(".hint").innerHTML = "<p>Tap on the left or right to navigate</p>";
	}
	</script>

	<div id="impress">
		<div id="intro" class="step slide" data-x="0" data-y="0">
			<h1>From URL to Query</h1>
			<h2>WordCamp Phoenix 2013</h2>

			<div class="intro-credits">
				<p>Erick Hitter</p>
				<p>Design Engineer @ Automattic</p>
				<p><a href="http://www.twitter.com/ethitter" target="_blank">@ethitter</a></p>
			</div>
		</div>

		<div class="step slide" data-x="1500" data-y="0">
			<h1>About Me</h1>

			<ul>
				<li>Design Engineer at Automattic, the company behind WordPress.com</li>
				<li>Formerly a Senior WordPress Developer with Oomph, Inc. working on the WordPress.com VIP platform</li>
				<li>3+ years developing WordPress themes and plugins</li>
				<li>WordPress Core Contributor</li>
				<li>WordCamp Boston Organizer</li>
				<li>Boston WordPress Meetup organizer</li>
				<li>Plugin Author</li>
			</ul>
		</div>

		<div class="step slide" data-x="1500" data-y="900">
			<h1>Assumptions we'll operate under</h1>

			<ul>
				<li>Using <a href="http://codex.wordpress.org/Using_Permalinks#mod_rewrite:_.22Pretty_Permalinks.22" target="_blank">Pretty Permalinks</a>.</li>
				<li>Not making requests to <code>/wp-admin/</code>.</li>
			</ul>
		</div>

		<div class="step slide" data-x="1500" data-y="1800">
			<h1>The Premise</h1>

			<p>&nbsp;</p>

			<ul>
				<li>Ever wonder what process WordPress undertakes when someone visits your site?</li>
				<li>Or how it translates that nice permalink to the database query that ultimately delivers the content your visitors requested?</li>
				<li>Or what it takes to load the appropriate template from your site's theme?</li>
			</ul>
		</div>

		<div class="step slide" data-x="3000" data-y="1800">
			<h1>In Short...</h1>

			<h1 class="middle" style="color: #4D4D4D;">Magic</h1>
		</div>

		<div class="step slide" data-x="4500" data-y="1800">
			<h1>Seriously though</h1>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<h2>WordPress contains a number of classes that work together with the help of some procedural glue.</h2>
		</div>

		<div class="step slide" data-x="4500" data-y="2700">
			<h1>Getting started: <code>index.php</code></h1>

			<p>With Pretty Permalinks, requests that don't correspond to actual files on the server are sent to <code>index.php</code>.</p>

			<p>Not much going on here:</p>

			<p>&nbsp;</p>

			<div class="code-container">
				<pre class="brush: php; gutter: true;">&lt;?php
/**
 * Front to the WordPress application. This file doesn't do anything, but loads
 * wp-blog-header.php which does and tells WordPress to load the theme.
 *
 * @package WordPress
 */

/**
 * Tells WordPress to load the WordPress theme and output it.
 *
 * @var bool
 */
define('WP_USE_THEMES', true);

/** Loads the WordPress Environment and Template */
require('./wp-blog-header.php');
</pre>
			</div><!-- .code-container -->
		</div>

		<div class="step slide" data-x="6000" data-y="2700">
			<h1><code>wp-blog-header.php</code></h1>

			<p>Not much here either, but what's here is <em>important</em>!</p>

			<p>&nbsp;</p>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [12,14,16]">&lt;?php
/**
 * Loads the WordPress environment and template.
 *
 * @package WordPress
 */

if ( !isset($wp_did_header) ) {

	$wp_did_header = true;

	require_once( dirname(__FILE__) . '/wp-load.php' );

	wp();

	require_once( ABSPATH . WPINC . '/template-loader.php' );

}
</pre>
			</div><!-- .code-container -->
		</div>

		<div class="step slide" data-x="7500" data-y="2700">
			<h1>In conclusion</h1>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<h2 style="text-align: center;">You caught those three highlighted lines, right?</h2>

			<p>&nbsp;</p>

			<h2 style="text-align: center;">So we can go home now?</h2>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<p style="text-align: center;"><small>:)</small></p>
		</div>

		<div class="step slide" data-x="9000" data-y="2700">
			<h1>What do I mean?</h1>

			<h2>Remember the premises?</h2>

			<p>&nbsp;</p>

			<div class="code-container">
				<pre class="brush: php; gutter: true;">&lt;?php
// Ever wonder what process WordPress undertakes when someone visits your site?
require_once( dirname(__FILE__) . '/wp-load.php' );

// Or how it translates that nice permalink to the database query that ultimately
// delivers the content your visitors requested?
wp();

// Or what it takes to load the appropriate template from your site's theme?
require_once( ABSPATH . WPINC . '/template-loader.php' );
</pre>
			</div><!-- .code-container -->
		</div>

		<div class="step slide" data-x="9000" data-y="3600">
			<h1><code>wp-load.php</code></h1>

			<p>You'll be shocked to learn that this file starts the process of loading WordPress.</p>

			<p>&nbsp;</p>

			<p>But how?</p>

			<p>&nbsp;</p>

			<p>Loads <code>wp-config.php</code>, which in turn loads <code>wp-settings.php</code>.</p>
		</div>

		<div class="step slide" data-x="10500" data-y="3600">
			<h1><code>wp-settings.php</code></h1>

			<p><a href="http://core.trac.wordpress.org/ticket/13237" title="Absense of alots lowers community morale - @JJJ" target="_blank">Alot</a> happens in here.</p>

			<ul>
				<li>At various stages, much of Core (<code>/wp-includes/</code>) is loaded, including Multisite if needed.</li>
				<li>WordPress attempts to connect to the database specificed in <code>wp-config.php</code>.</li>
				<li>Persistent caching is loaded and initialized.</li>
				<li>Active plugins are loaded.</li>
				<li>Active theme's <code>functions.php</code> file loads.</li>
			</ul>
		</div>

		<div class="step slide" data-x="12000" data-y="3600">
			<h1><code>wp-settings.php</code></h1>

			<p>Up to now, we've mostly been loading additional files, defining constants, and calling an occassional function.</p>

			<p>In other words, lots of glue, nothing to stick together, yet.</p>

			<p>&nbsp;</p>

			<p>Now, these classes (and more) are instantiated into their global variables.</p>

			<ul>
				<li><code>WP_Query</code></li>
				<li><code>WP_Rewrite</code></li>
				<li><code>WP</code></li>
				<li><code>WP_Roles</code></li>
			</ul>
		</div>

		<div class="step slide" data-x="13500" data-y="3600">
			<h1>But wait, there's more!</h1>

			<h2><code>wp-settings.php</code>, that is.</h2>

			<p>&nbsp;</p>

			<ul>
				<li>Set up information about the current user, if someone is logged in.</li>
				<li>
					Actions!
					<ul>
						<li><code>after_setup_theme</code></li>
						<li><code>init</code></li>
						<li><code>wp_loaded</code></li>
					</ul>
				</li>
			</ul>
		</div>

		<div class="step slide" data-x="15000" data-y="3600">
			<h1>So where are we now?</h1>

			<ul>
				<li>Most of WordPress' core functionality is loaded.</li>
				<li>Plugins and the theme's <code>functions.php</code> are running.</li>
				<li>Common global variables are instantiated with their corresponding classes.</li>
				<li>The user is logged in.</li>
			</ul>

			<p>&nbsp;</p>

			<p>&nbsp;</p>

			<h1>Now what?</h1>
		</div>

		<div class="step slide" data-x="15000" data-y="4500">
			<h1>Let's find some posts!</h1>

			<p>At this point, we're back in <code>wp-blog-header.php</code>.</p>

			<p>&nbsp;</p>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [5,6,7];">&lt;?php
// Ever wonder what process WordPress undertakes when someone visits your site?
require_once( dirname(__FILE__) . '/wp-load.php' );

// Or how it translates that nice permalink to the database query that ultimately
// delivers the content your visitors requested?
wp();

// Or what it takes to load the appropriate template from your site's theme?
require_once( ABSPATH . WPINC . '/template-loader.php' );
</pre>
			</div><!-- .code-container -->
		</div>

		<div class="step slide" data-x="16500" data-y="4500">
			<h1><code>wp()</code></h1>

			<h2>Short function name, big responsibilities.</h2>

			<p>After all, it:</p>

			<ul>
				<li>confirms the current user;</li>
				<li>determines what to query the database for based on the URL;</li>
				<li>executes said queries;</li>
				<li>sets more global variables, such as <code>$post</code>;</li>
				<li>and fires the <code>wp</code> action.</li>
			</ul>
		</div>

		<div class="step slide" data-x="18000" data-y="4500">
			<h1><code>WP::parse_request()</code></h1>

			<p>This utilizes <code>WP_Rewrite</code>'s rules, which are nothing more than regular expressions.</p>

			<p>&nbsp;</p>

			<p>The rules are looped through until a match is found.</p>

			<p>The <code>request</code> filter and <code>parse_request</code> action both fire. Both can be used to change the query WP runs next.</p>

			<p>&nbsp;</p>

			<p>If a match is found, we have query variables for <code>WP_Query</code>.</p>

			<p>If not, we're headed to the homepage.</p>
		</div>

		<div class="step slide" data-x="19500" data-y="4500">
			<h1>And now, we query</h1>

			<p>Using <code>WP_Query</code> and the query variables already determined, WP goes to the database.</p>

			<p>Before running the query, the <code>pre_get_posts</code> action fires, providing another opportunity to modify the query.</p>

			<p>&nbsp;</p>

			<p>Since this is the main query, both <code>$wp_query</code> and <code>$wp_the_query</code> are populated with the query object.</p>

			<p>Otherwise, this is no different than using <code>new WP_Query</code> or <code>get_posts()</code>.</p>
		</div>

		<div class="step slide" data-x="22500" data-y="3600">
			<h1><code>map_meta_cap</code></h1>

			<h2><code>map_meta_cap()</code> is in <code>wp-includes/capabilities.php</code>.</h2>

			<p>&nbsp;</p>

			<p>Within that function is the <code>map_meta_cap</code> filter.</p>

			<p>&nbsp;</p>

			<p>WordPress handles the function, we really care about the filter.</p>
		</div>

		<div class="step slide" data-x="24000" data-y="3600">
			<h1><code>map_meta_cap</code></h1>

			<code>apply_filters('map_meta_cap', $caps, $cap, $user_id, $args)</code>

			<ul>
				<li><code>'map_meta_cap'</code>: filter name</li>
				<li><code>$caps</code>: all of the meta capabilities already determined by WordPress</li>
				<li><code>$cap</code>: the primitive capability that triggered this filter call</li>
				<li><code>$user_id</code>: user ID either for the current user or a specific user when using <code>user_can()</code></li>
				<li><code>$args</code>: optional additional information relevant to current capability check</li>
			</ul>
		</div>

		<div class="step slide" data-x="25500" data-y="3600">
			<h1><code>$args</code></h1>

			<p><strong>This is important!</strong></p>

			<p>&nbsp;</p>

			<p>The <code>$args</code> parameter is both incredibly useful, and annoyingly vague.</p>

			<p>&nbsp;</p>

			<p><code>$args</code> is a numerically-indexed array whose values contain data relevant to the current capabilities check.</p>

			<p>&nbsp;</p>

			<p>Unfortunately, isn't always populated, forcing one to use globals in some cases.</p>

			<p>&nbsp;</p>

			<p>Clear as mud, right?</p>
		</div>

		<div class="step slide" data-x="27000" data-y="3600">
			<h1>Block deletion</h1>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [18];">&lt;?php
/**
 * Prevent a post from being deleted if a meta key is present
 *
 * @param array $caps
 * @param string $cap
 * @param int $user_id
 * @param array $args
 * @uses get_post_meta
 * @filter map_meta_cap
 * @return array
 */
function wcto_block_post_deletion( $caps, $cap, $user_id, $args ) {
	if (
		'delete_post' == $cap
		&& get_post_meta( (int) $args[0], '_block_deletion', true )
	)
		$caps[] = 'do_not_allow';

	return $caps;
}
add_filter( 'map_meta_cap', 'wcto_block_post_deletion', 10, 4 );
?&gt;</pre>
			</div>
		</div>

		<div class="step slide" data-x="28500" data-y="3600">
			<h1>Block file uploads</h1>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [18];">&lt;?php
/**
 * Prevent specific users from uploading files
 *
 * @param array $caps
 * @param string $cap
 * @param int $user_id
 * @param array $args
 * @uses get_user_meta
 * @filter map_meta_cap
 * @return array
 */
function wcto_limit_uploads( $caps, $cap, $user_id, $args ) {
	if (
		'upload_files' == $cap
		&& (bool) get_user_meta( $user_id, 'disallow_uploads', true )
	)
		$caps[] = 'do_not_allow';

	return $caps;
}
add_filter( 'map_meta_cap', 'wcto_limit_uploads', 10, 4 );
?&gt;</pre>
			</div>
		</div>

		<div class="step slide" data-x="30000" data-y="3600">
			<h1>Magic of <code>do_not_allow</code></h1>

			<p>When preventing something, you don't need to remove the capabilities that let a user perform an action.</p>

			<p><code style="text-decoration: line-through;">unset( $caps['edit_posts'] );</code></p>

			<p>&nbsp;</p>

			<p>Instead, add <code>do_not_allow</code> to the <code>$caps</code> array and WP ignores the other meta capabilities it determined.</p>
		</div>

		<div class="step slide" data-x="31500" data-y="3600">
			<h1>Allow editing</h1>

			<div class="code-container">
				<pre class="brush: php; gutter: true; highlight: [20];">&lt;?php
/**
 * Allow a contributor to edit a particular published post
 *
 * @param array $caps
 * @param string $cap
 * @param int $user_id
 * @param array $args
 * @uses get_post_meta
 * @filter map_meta_cap
 * @return array
 */
function wcto_allow_contrib_edit_post( $caps, $cap, $user_id, $args ) {
	if (
		'edit_post' == $cap
		&& isset( $args[0] )
		&& (bool) get_post_meta( (int) $args[0], '_allow_contribs_to_edit', true )
		&& get_post_field( 'post_author', (int) $args[0] ) == $user_id
	)
		$caps = array( 'edit_posts' );

	return $caps;
}
add_filter( 'map_meta_cap', 'wcto_allow_contrib_edit_post', 10, 4 );
?&gt;</pre>
			</div>
		</div>

		<div class="step slide" data-x="33000" data-y="3600">
			<h1>Note about overriding</h1>

			<p>When overriding to grant a capability, you often must clear the <code>$caps</code> array of the capabilities you're overridding.</p>

			<p>In other words, there is no <code>allow</code> cap that has the opposite effect as <code>do_not_allow</code>.</p>
		</div>

		<div class="step slide" data-x="33000" data-y="4500">
			<h1>Questions?</h1>

			<h2>Slides are available at <a href="http://www.ethitter.com/blog/" target="_blank">http://www.ethitter.com/blog/</a>.</h2>

			<h2>Check Twitter for a link as well: <a href="http://www.twitter.com/ethitter" target="_blank">@ethitter</a>.</h2>
		<!-- end -->
	</div>
	<!--

			Last, but not least.

			To make all described above really work, you need to include impress.js in the page.
			I strongly encourage to minify it first.

			In here I just include full source of the script to make it more readable.

			You also need to call a `impress().init()` function to initialize impress.js presentation.
			And you should do it in the end of your document. Not only because it's a good practice, but also
			because it should be done when the whole document is ready.
			Of course you can wrap it in any kind of "DOM ready" event, but I was too lazy to do so ;)

	-->
	<script src="../impress-js-master/impress.js"></script>
	<script>SyntaxHighlighter.all(); impress().init();</script>

	</body>
</html>

